<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="Personal note-taking app with text, links, and file support">
    <meta name="theme-color" content="#6366f1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="My Notes">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/svg+xml" href="/static/icon-192.svg">
    <link rel="apple-touch-icon" href="/static/icon-192.svg">
    
    <title>My Notes</title>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #f8fafc;
            --bg-card: #ffffff;
            --sidebar-bg: #f1f5f9;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 320px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .sidebar-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .sidebar-header p {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .new-note-btn {
            margin: 1rem;
            padding: 0.875rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .new-note-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .search-container {
            padding: 0 1rem 1rem 1rem;
        }

        .search-container input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 0.9rem;
            background: white;
            transition: all 0.2s;
        }

        .search-container input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .timeline-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 0.5rem;
        }

        .timeline-item {
            background: white;
            border-radius: 10px;
            padding: 0.875rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .timeline-item:hover {
            border-color: var(--primary);
            transform: translateX(4px);
        }

        .timeline-item.active {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .timeline-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .timeline-item-type {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-weight: 600;
        }

        .timeline-item-type.text {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }

        .timeline-item-type.link {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .timeline-item-type.file {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .timeline-item-time {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        .timeline-item-preview {
            font-size: 0.875rem;
            color: var(--text);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .timeline-item-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }

        .timeline-tag {
            font-size: 0.7rem;
            padding: 0.125rem 0.375rem;
            background: rgba(100, 116, 139, 0.1);
            color: var(--text-light);
            border-radius: 4px;
        }

        .empty-sidebar {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-light);
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .content-header {
            padding: 1.5rem;
            background: white;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .content-body {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }

        /* Note Form */
        .note-form {
            max-width: 800px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text);
            font-size: 0.9rem;
        }

        textarea, input[type="text"], input[type="url"] {
            width: 100%;
            padding: 0.875rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.2s;
            background: white;
        }

        textarea:focus, input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        textarea {
            min-height: 120px;
            max-height: 400px;
            overflow-y: auto;
            resize: none;
        }

        /* Quick Templates */
        .quick-templates {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        .template-btn {
            padding: 1rem;
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            color: var(--text);
        }

        .template-btn:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .template-btn span:first-child {
            font-size: 2rem;
        }

        /* Floating Labels */
        .floating-label-group {
            position: relative;
        }

        .floating-label-group input,
        .floating-label-group textarea {
            padding-top: 1.5rem;
            padding-bottom: 0.5rem;
        }

        .floating-label-group label {
            position: absolute;
            left: 0.875rem;
            top: 1rem;
            transition: all 0.2s;
            pointer-events: none;
            color: var(--text-light);
            font-weight: 500;
            background: transparent;
        }

        .floating-label-group input:focus + label,
        .floating-label-group input:not(:placeholder-shown) + label,
        .floating-label-group textarea:focus + label,
        .floating-label-group textarea:not(:placeholder-shown) + label {
            top: 0.25rem;
            font-size: 0.75rem;
            color: var(--primary);
        }

        /* Character Counter */
        .char-counter {
            position: absolute;
            right: 0.875rem;
            bottom: 0.75rem;
            font-size: 0.75rem;
            color: var(--text-light);
            background: rgba(255, 255, 255, 0.9);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
        }

        /* Enhanced File Upload Zone */
        .file-upload-zone {
            position: relative;
            border: 3px dashed var(--border);
            border-radius: 16px;
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.3s;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.02), rgba(99, 102, 241, 0.05));
            cursor: pointer;
        }

        .file-upload-zone:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.08);
            transform: scale(1.01);
        }

        .file-upload-zone.dragover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.15);
            border-style: solid;
        }

        .file-upload-zone input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        .upload-content {
            pointer-events: none;
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .upload-text strong {
            color: var(--primary);
            font-size: 1.1rem;
        }

        .upload-hint {
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-light);
        }

        /* File Preview Grid */
        .file-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .file-preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid var(--border);
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            transition: all 0.2s;
        }

        .file-preview-item:hover {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .file-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }

        .file-preview-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        .file-preview-name {
            font-size: 0.7rem;
            text-align: center;
            word-break: break-word;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .file-remove-btn {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }

        .file-preview-item:hover .file-remove-btn {
            opacity: 1;
        }

        /* Tag Suggestions */
        .tag-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .tag-suggestion {
            padding: 0.375rem 0.75rem;
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .tag-suggestion:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        /* Enhanced Form Actions */
        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
        }

        .btn-large {
            padding: 1rem 2.5rem;
            font-size: 1.1rem;
        }

        /* Animations */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .note-form {
            animation: slideInUp 0.3s ease-out;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem;
            background: white;
            border: 2px dashed var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            color: var(--text-light);
        }

        .file-input-label:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
            color: var(--primary);
        }

        input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        .file-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .file-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .btn {
            padding: 0.875rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            min-height: 48px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--bg);
            color: var(--text);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            background: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Note Display */
        .note-display {
            max-width: 900px;
            margin: 0 auto;
        }

        .note-display-header {
            margin-bottom: 2rem;
        }

        .note-display-type {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .note-display-type.text {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }

        .note-display-type.link {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .note-display-type.file {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .note-display-time {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }

        .note-display-content {
            font-size: 1.1rem;
            line-height: 1.8;
            color: var(--text);
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .note-display-link {
            display: inline-block;
            color: var(--primary);
            text-decoration: none;
            padding: 1rem;
            background: rgba(99, 102, 241, 0.05);
            border-radius: 10px;
            border-left: 3px solid var(--primary);
            word-break: break-all;
        }

        .note-display-link:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        .note-display-image {
            width: 100%;
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            margin: 1rem 0;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
        }

        .note-display-file {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            text-decoration: none;
            color: var(--text);
            font-weight: 500;
            transition: all 0.2s;
        }

        .note-display-file:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
            color: var(--primary);
        }

        .note-display-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }

        .note-tag {
            padding: 0.375rem 0.75rem;
            background: rgba(100, 116, 139, 0.1);
            color: var(--text-light);
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .note-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
        }

        .welcome-screen {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-light);
        }

        .welcome-screen svg {
            width: 120px;
            height: 120px;
            margin-bottom: 1.5rem;
            opacity: 0.3;
        }

        .welcome-screen h2 {
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
        }

        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--success);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -320px;
                width: 320px;
                height: 100vh;
                z-index: 1000;
                transition: left 0.3s;
            }

            .sidebar.open {
                left: 0;
            }

            .mobile-menu-btn {
                position: fixed;
                top: 1rem;
                left: 1rem;
                z-index: 999;
                background: var(--primary);
                color: white;
                border: none;
                padding: 0.75rem;
                border-radius: 10px;
                cursor: pointer;
                box-shadow: var(--shadow-lg);
            }

            .overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
            }

            .overlay.show {
                display: block;
            }

            .content-body {
                padding: 1rem;
            }

            .note-form {
                padding: 0;
            }

            .quick-templates {
                grid-template-columns: repeat(2, 1fr);
            }

            .file-preview-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .note-count-badge {
            background: white;
            color: var(--primary);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <button class="mobile-menu-btn" id="mobileMenuBtn" style="display: none;">‚ò∞</button>
    <div class="overlay" id="overlay"></div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1>üìù My Notes</h1>
                <p>Your personal note space</p>
            </div>

            <button class="new-note-btn" id="newNoteBtn">
                <span>‚ú®</span>
                <span>New Note</span>
            </button>

            <div class="search-container">
                <input type="text" id="searchInput" placeholder="üîç Search notes...">
            </div>

            <div class="timeline-list" id="timelineList">
                <div class="loading" id="sidebarLoading">
                    <div class="spinner"></div>
                    <p>Loading notes...</p>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-header">
                <h2 id="contentTitle">New Note</h2>
                <span class="note-count-badge" id="noteCountBadge">0 notes</span>
            </div>

            <div class="content-body" id="contentBody">
                <!-- Welcome Screen -->
                <div class="welcome-screen" id="welcomeScreen">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <h2>Welcome to My Notes</h2>
                    <p>Click "New Note" to create your first note</p>
                </div>

                <!-- Note Form (Hidden initially) -->
                <div class="note-form" id="noteForm" style="display: none;">
                    <!-- Quick Templates -->
                    <div class="quick-templates">
                        <button type="button" class="template-btn" onclick="selectTemplate('text')">
                            <span>üìù</span>
                            <span>Text Note</span>
                        </button>
                        <button type="button" class="template-btn" onclick="selectTemplate('link')">
                            <span>üîó</span>
                            <span>Link</span>
                        </button>
                        <button type="button" class="template-btn" onclick="selectTemplate('file')">
                            <span>üìé</span>
                            <span>Files</span>
                        </button>
                        <button type="button" class="template-btn" onclick="selectTemplate('quick')">
                            <span>‚ö°</span>
                            <span>Quick Note</span>
                        </button>
                    </div>

                    <form id="createNoteForm">
                        <div class="form-group floating-label-group">
                            <textarea id="content" name="content" placeholder=" " rows="1"></textarea>
                            <label for="content">‚úçÔ∏è What's on your mind?</label>
                            <div class="char-counter" id="charCounter">0 characters</div>
                        </div>

                        <div class="form-group floating-label-group" id="linkGroup">
                            <input type="url" id="link" name="link" placeholder=" ">
                            <label for="link">üîó Paste a link</label>
                        </div>

                        <div class="form-group">
                            <div class="file-upload-zone" id="fileUploadZone">
                                <input type="file" id="files" name="files" multiple>
                                <div class="upload-content">
                                    <div class="upload-icon">üìÅ</div>
                                    <div class="upload-text">
                                        <strong>Drop files here</strong> or click to browse
                                    </div>
                                    <div class="upload-hint">Images, PDFs, documents, videos...</div>
                                </div>
                            </div>
                            <div id="filePreview" class="file-preview-grid"></div>
                        </div>

                        <div class="form-group floating-label-group">
                            <input type="text" id="tags" name="tags" placeholder=" ">
                            <label for="tags">üè∑Ô∏è Add tags</label>
                            <div class="tag-suggestions" id="tagSuggestions"></div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary btn-large">
                                <span>üíæ</span>
                                <span>Save Note</span>
                            </button>
                            <button type="button" class="btn btn-secondary" id="cancelBtn">
                                <span>‚úñÔ∏è</span>
                                <span>Cancel</span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Note Display (Hidden initially) -->
                <div class="note-display" id="noteDisplay" style="display: none;"></div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let allNotes = [];
        let selectedNoteId = null;
        let searchTimeout;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadNotes();
            setupEventListeners();
            checkMobileView();
        });

        function setupEventListeners() {
            // New note button
            document.getElementById('newNoteBtn').addEventListener('click', showNoteForm);
            
            // Cancel button
            document.getElementById('cancelBtn').addEventListener('click', showWelcomeScreen);
            
            // Form submission
            document.getElementById('createNoteForm').addEventListener('submit', handleSubmit);
            
            // File input
            document.getElementById('files').addEventListener('change', handleFilePreview);
            
            // Search
            document.getElementById('searchInput').addEventListener('input', handleSearch);
            
            // Mobile menu
            document.getElementById('mobileMenuBtn').addEventListener('click', toggleMobileMenu);
            document.getElementById('overlay').addEventListener('click', toggleMobileMenu);
            
            // Responsive
            window.addEventListener('resize', checkMobileView);

            // Character counter and auto-expand textarea
            document.getElementById('content').addEventListener('input', (e) => {
                const counter = document.getElementById('charCounter');
                if (counter) {
                    const length = e.target.value.length;
                    counter.textContent = `${length} character${length !== 1 ? 's' : ''}`;
                    
                    // Auto-expand textarea
                    e.target.style.height = 'auto';
                    e.target.style.height = Math.min(e.target.scrollHeight, 400) + 'px';
                }
            });

            // Drag and drop
            setupDragAndDrop();

            // Tag suggestions
            setupTagSuggestions();
        }

        function checkMobileView() {
            const isMobile = window.innerWidth <= 768;
            document.getElementById('mobileMenuBtn').style.display = isMobile ? 'block' : 'none';
        }

        function toggleMobileMenu() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('show');
        }

        function handleFilePreview(e) {
            const preview = document.getElementById('filePreview');
            preview.innerHTML = '';
            
            Array.from(e.target.files).forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-preview-item';
                
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        item.innerHTML = `
                            <img src="${e.target.result}" alt="${file.name}">
                            <button class="file-remove-btn" type="button" onclick="removeFile(${index})" title="Remove file">‚úï</button>
                        `;
                    };
                    reader.readAsDataURL(file);
                } else {
                    const icon = getFileIcon(file.type);
                    item.innerHTML = `
                        <div class="file-preview-icon">${icon}</div>
                        <div class="file-preview-name">${file.name}</div>
                        <button class="file-remove-btn" type="button" onclick="removeFile(${index})" title="Remove file">‚úï</button>
                    `;
                }
                
                preview.appendChild(item);
            });
        }

        async function handleSubmit(e) {
            e.preventDefault();
            
            const formData = new FormData();
            const content = document.getElementById('content').value.trim();
            const link = document.getElementById('link').value.trim();
            const tags = document.getElementById('tags').value.trim();
            const files = document.getElementById('files').files;

            if (!content && !link && files.length === 0) {
                showToast('Please add some content, a link, or files', 'error');
                return;
            }

            if (content) formData.append('content', content);
            if (link) formData.append('link', link);
            if (tags) formData.append('tags', tags);
            
            Array.from(files).forEach(file => {
                formData.append('files', file);
            });

            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerHTML = '<span>‚è≥</span><span>Saving...</span>';

            try {
                const response = await fetch(`${API_BASE}/api/notes`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Note saved successfully! ‚úÖ');
                    e.target.reset();
                    document.getElementById('filePreview').innerHTML = '';
                    await loadNotes();
                    showWelcomeScreen();
                } else {
                    showToast('Failed to save note', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error saving note', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>üíæ</span><span>Save Note</span>';
            }
        }

        async function loadNotes(searchQuery = '') {
            try {
                const url = searchQuery 
                    ? `${API_BASE}/api/notes?search=${encodeURIComponent(searchQuery)}`
                    : `${API_BASE}/api/notes`;
                
                const response = await fetch(url);
                const data = await response.json();

                allNotes = data.notes || [];
                
                document.getElementById('noteCountBadge').textContent = 
                    `${data.total} note${data.total !== 1 ? 's' : ''}`;
                
                renderTimeline(allNotes);
                
                const loadingEl = document.getElementById('sidebarLoading');
                if (loadingEl) loadingEl.style.display = 'none';
            } catch (error) {
                console.error('Error loading notes:', error);
                
                const loadingEl = document.getElementById('sidebarLoading');
                if (loadingEl) loadingEl.style.display = 'none';
                showToast('Error loading notes', 'error');
            }
        }

        function renderTimeline(notes) {
            const timeline = document.getElementById('timelineList');
            
            if (notes.length === 0) {
                timeline.innerHTML = '<div class="empty-sidebar">No notes found</div>';
                return;
            }

            timeline.innerHTML = notes.map(note => {
                const preview = getPreviewText(note);
                const typeIcon = {
                    'text': 'üìù',
                    'link': 'üîó',
                    'file': 'üìé'
                }[note.note_type] || 'üìÑ';

                const tagsHTML = note.tags ? 
                    note.tags.split(',').map(t => t.trim()).filter(t => t)
                        .map(tag => `<span class="timeline-tag">${escapeHtml(tag)}</span>`)
                        .join('') : '';

                return `
                    <div class="timeline-item ${selectedNoteId === note.id ? 'active' : ''}" 
                         onclick="viewNote(${note.id})"
                         data-note-id="${note.id}">
                        <div class="timeline-item-header">
                            <span class="timeline-item-type ${note.note_type}">
                                ${typeIcon} ${note.note_type}
                            </span>
                            <span class="timeline-item-time">
                                ${formatTimestamp(note.created_at)}
                            </span>
                        </div>
                        <div class="timeline-item-preview">${preview}</div>
                        ${tagsHTML ? `<div class="timeline-item-tags">${tagsHTML}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function getPreviewText(note) {
            if (note.note_type === 'text') {
                return escapeHtml(note.content.substring(0, 100));
            } else if (note.note_type === 'link') {
                return `üåê ${escapeHtml(note.content)}`;
            } else if (note.note_type === 'file') {
                return `${getFileIcon(note.mime_type)} ${escapeHtml(note.file_name)}`;
            }
            return 'Note';
        }

        async function viewNote(noteId) {
            selectedNoteId = noteId;
            const note = allNotes.find(n => n.id === noteId);
            
            if (!note) return;

            // Update active state in timeline
            document.querySelectorAll('.timeline-item').forEach(item => {
                item.classList.remove('active');
                if (parseInt(item.dataset.noteId) === noteId) {
                    item.classList.add('active');
                }
            });

            // Hide form and welcome, show display
            document.getElementById('noteForm').style.display = 'none';
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('noteDisplay').style.display = 'block';

            document.getElementById('contentTitle').textContent = 
                note.note_type.charAt(0).toUpperCase() + note.note_type.slice(1) + ' Note';

            // Render note content
            const typeIcon = {
                'text': 'üìù',
                'link': 'üîó',
                'file': 'üìé'
            }[note.note_type] || 'üìÑ';

            let contentHTML = '';

            if (note.note_type === 'text') {
                contentHTML = `<div class="note-display-content">${escapeHtml(note.content)}</div>`;
            } else if (note.note_type === 'link') {
                contentHTML = `
                    <a href="${escapeHtml(note.content)}" target="_blank" class="note-display-link">
                        üåê ${escapeHtml(note.content)}
                    </a>
                `;
            } else if (note.note_type === 'file') {
                const filename = note.file_path.split('/').pop();
                const fileUrl = `/files/${filename}`;
                const isImage = note.mime_type && note.mime_type.startsWith('image/');

                if (isImage) {
                    contentHTML = `
                        <img src="${fileUrl}" 
                             alt="${escapeHtml(note.file_name)}" 
                             class="note-display-image"
                             onclick="window.open('${fileUrl}', '_blank')">
                    `;
                } else {
                    contentHTML = `
                        <a href="${fileUrl}" target="_blank" class="note-display-file">
                            <span>${getFileIcon(note.mime_type)}</span>
                            <span>${escapeHtml(note.file_name)}</span>
                        </a>
                    `;
                }

                if (note.content) {
                    contentHTML = `<div class="note-display-content">${escapeHtml(note.content)}</div><br>` + contentHTML;
                }
            }

            const tagsHTML = note.tags ? 
                `<div class="note-display-tags">
                    ${note.tags.split(',').map(t => t.trim()).filter(t => t)
                        .map(tag => `<span class="note-tag">üè∑Ô∏è ${escapeHtml(tag)}</span>`)
                        .join('')}
                </div>` : '';

            document.getElementById('noteDisplay').innerHTML = `
                <div class="note-display-header">
                    <div class="note-display-type ${note.note_type}">
                        ${typeIcon} ${note.note_type.toUpperCase()}
                    </div>
                    <div class="note-display-time">
                        üïí ${formatFullTimestamp(note.created_at)}
                    </div>
                </div>
                ${contentHTML}
                ${tagsHTML}
                <div class="note-actions">
                    <button class="btn btn-danger" onclick="deleteNote(${note.id})">
                        <span>üóëÔ∏è</span>
                        <span>Delete</span>
                    </button>
                </div>
            `;

            // Close mobile menu if open
            if (window.innerWidth <= 768) {
                toggleMobileMenu();
            }
        }

        async function deleteNote(noteId) {
            if (!confirm('Are you sure you want to delete this note?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/notes/${noteId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Note deleted ‚úÖ');
                    await loadNotes();
                    showWelcomeScreen();
                } else {
                    showToast('Failed to delete note', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error deleting note', 'error');
            }
        }

        function showNoteForm() {
            selectedNoteId = null;
            document.querySelectorAll('.timeline-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('noteDisplay').style.display = 'none';
            document.getElementById('noteForm').style.display = 'block';
            document.getElementById('contentTitle').textContent = 'New Note';
            
            // Clear form
            document.getElementById('createNoteForm').reset();
            document.getElementById('filePreview').innerHTML = '';
            
            // Reset character counter and textarea height
            const textarea = document.getElementById('content');
            const counter = document.getElementById('charCounter');
            if (textarea) {
                textarea.style.height = 'auto';
            }
            if (counter) {
                counter.textContent = '0 characters';
            }

            // Close mobile menu if open
            if (window.innerWidth <= 768) {
                toggleMobileMenu();
            }
        }

        function showWelcomeScreen() {
            selectedNoteId = null;
            document.querySelectorAll('.timeline-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.getElementById('noteForm').style.display = 'none';
            document.getElementById('noteDisplay').style.display = 'none';
            document.getElementById('welcomeScreen').style.display = 'block';
            document.getElementById('contentTitle').textContent = 'My Notes';
        }

        function handleSearch(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                loadNotes(e.target.value.trim());
            }, 300);
        }

        // Utility functions
        function formatTimestamp(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;

            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function formatFullTimestamp(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getFileIcon(mimeType) {
            if (!mimeType) return 'üìÑ';
            if (mimeType.startsWith('image/')) return 'üñºÔ∏è';
            if (mimeType.startsWith('video/')) return 'üé•';
            if (mimeType.startsWith('audio/')) return 'üéµ';
            if (mimeType.includes('pdf')) return 'üìï';
            if (mimeType.includes('word') || mimeType.includes('document')) return 'üìò';
            if (mimeType.includes('sheet') || mimeType.includes('excel')) return 'üìä';
            if (mimeType.includes('zip') || mimeType.includes('rar')) return 'üì¶';
            return 'üìÑ';
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            
            if (type === 'error') {
                toast.style.background = 'var(--danger)';
            }

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Template selection
        function selectTemplate(type) {
            const content = document.getElementById('content');
            const link = document.getElementById('link');
            const files = document.getElementById('files');
            
            // Focus appropriate field
            if (type === 'text' || type === 'quick') {
                content.focus();
            } else if (type === 'link') {
                link.focus();
            } else if (type === 'file') {
                files.click();
            }
        }

        // Remove file from preview
        function removeFile(index) {
            const fileInput = document.getElementById('files');
            const dt = new DataTransfer();
            const { files } = fileInput;
            
            for (let i = 0; i < files.length; i++) {
                if (i !== index) {
                    dt.items.add(files[i]);
                }
            }
            
            fileInput.files = dt.files;
            handleFilePreview({ target: fileInput });
        }

        // Drag and drop setup
        function setupDragAndDrop() {
            const uploadZone = document.getElementById('fileUploadZone');
            if (!uploadZone) return;

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadZone.addEventListener(eventName, () => {
                    uploadZone.classList.add('dragover');
                }, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, () => {
                    uploadZone.classList.remove('dragover');
                }, false);
            });
            
            uploadZone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                document.getElementById('files').files = files;
                handleFilePreview({ target: { files } });
            }, false);
        }

        // Tag suggestions setup
        function setupTagSuggestions() {
            const commonTags = ['work', 'personal', 'ideas', 'important', 'todo', 'urgent', 'project'];
            const tagSuggestions = document.getElementById('tagSuggestions');
            
            if (tagSuggestions) {
                tagSuggestions.innerHTML = commonTags.map(tag => 
                    `<span class="tag-suggestion" onclick="addTag('${tag}')">${tag}</span>`
                ).join('');
            }
        }

        // Add tag
        function addTag(tag) {
            const tagInput = document.getElementById('tags');
            const current = tagInput.value.trim();
            
            // Don't add if already exists
            const tags = current.split(',').map(t => t.trim()).filter(t => t);
            if (tags.includes(tag)) return;
            
            tagInput.value = current ? `${current}, ${tag}` : tag;
            tagInput.focus();
        }

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                    .then((registration) => {
                        console.log('‚úÖ Service Worker registered:', registration);
                    })
                    .catch((error) => {
                        console.log('‚ùå Service Worker registration failed:', error);
                    });
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button/toast
            const installToast = document.createElement('div');
            installToast.className = 'toast';
            installToast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <span>üì± Install app on your device?</span>
                    <button onclick="installPWA()" style="background: white; color: var(--primary); border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        Install
                    </button>
                </div>
            `;
            installToast.style.background = 'var(--primary)';
            installToast.style.maxWidth = '400px';
            document.body.appendChild(installToast);
            
            setTimeout(() => {
                installToast.remove();
            }, 8000);
        });

        window.installPWA = async function() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response: ${outcome}`);
                deferredPrompt = null;
            }
        };

        // Handle PWA install success
        window.addEventListener('appinstalled', () => {
            showToast('üéâ App installed successfully!');
            deferredPrompt = null;
        });
    </script>
</body>
</html>
